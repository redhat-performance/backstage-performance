---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rhdh-pgbouncer-config
  namespace: rhdh-performance
data:
  pgbouncer.ini: |
    [databases]
    * = host=rhdh-postgresql-primary port=5432

    [pgbouncer]
    listen_addr = 0.0.0.0
    listen_port = 5432
    auth_type = md5
    auth_file = /pgconf/userlist.txt
    
    ; Pool settings
    pool_mode = transaction
    max_client_conn = ${PGBOUNCER_MAX_CLIENT_CONNECTIONS}
    default_pool_size = ${PGBOUNCER_DEFAULT_POOL_SIZE}
    min_pool_size = 5
    reserve_pool_size = 5
    reserve_pool_timeout = 3
    
    ; Connection limits
    ; These should be coordinated with PostgreSQL max_connections (500)
    ; max_db_connections: max connections per database to PostgreSQL
    ; max_user_connections: max total connections per user (postgres) - this is often the bottleneck
    max_db_connections = ${PGBOUNCER_MAX_DB_CONNECTIONS}
    max_user_connections = ${PGBOUNCER_MAX_USER_CONNECTIONS}
    
    ; Timeouts
    server_connect_timeout = 15
    server_idle_timeout = 600
    server_lifetime = 3600
    client_idle_timeout = 0
    
    ; Logging
    log_connections = 1
    log_disconnections = 1
    log_pooler_errors = 1
    stats_period = 60
    
    ; Admin
    admin_users = postgres
    ignore_startup_parameters = extra_float_digits
---
apiVersion: v1
kind: Secret
metadata:
  name: rhdh-pgbouncer-userlist
  namespace: rhdh-performance
type: Opaque
stringData:
  userlist.txt: |
    "postgres" "Txv4Ch4gsL"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rhdh-pgbouncer
  namespace: rhdh-performance
  labels:
    app: pgbouncer
    app.kubernetes.io/name: pgbouncer
    app.kubernetes.io/instance: rhdh
spec:
  replicas: 2
  selector:
    matchLabels:
      app: pgbouncer
      app.kubernetes.io/instance: rhdh
  template:
    metadata:
      labels:
        app: pgbouncer
        app.kubernetes.io/name: pgbouncer
        app.kubernetes.io/instance: rhdh
    spec:
      imagePullSecrets:
        - name: rhdh-pull-secret
      containers:
        - name: pgbouncer
          image: registry.connect.redhat.com/crunchydata/crunchy-pgbouncer:ubi9-1.24-2547
          command:
            - /usr/bin/pgbouncer
            - /pgconf/pgbouncer.ini
          ports:
            - containerPort: 5432
              name: pgbouncer
          volumeMounts:
            - name: pgbouncer-config
              mountPath: /pgconf/pgbouncer.ini
              subPath: pgbouncer.ini
            - name: pgbouncer-userlist
              mountPath: /pgconf/userlist.txt
              subPath: userlist.txt
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi
          livenessProbe:
            tcpSocket:
              port: 5432
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            tcpSocket:
              port: 5432
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: pgbouncer-config
          configMap:
            name: rhdh-pgbouncer-config
        - name: pgbouncer-userlist
          secret:
            secretName: rhdh-pgbouncer-userlist
---
apiVersion: v1
kind: Service
metadata:
  name: rhdh-pgbouncer
  namespace: rhdh-performance
  labels:
    app: pgbouncer
    app.kubernetes.io/name: pgbouncer
    app.kubernetes.io/instance: rhdh
spec:
  type: ClusterIP
  ports:
    - port: 5432
      targetPort: 5432
      protocol: TCP
      name: pgbouncer
  selector:
    app: pgbouncer
    app.kubernetes.io/instance: rhdh

